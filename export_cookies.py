#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Script t·ª± ƒë·ªông export cookies t·ª´ tr√¨nh duy·ªát
"""

import sys
from pathlib import Path

try:
    import browser_cookie3
except ImportError:
    print("‚ùå Thi·∫øu th∆∞ vi·ªán browser_cookie3!")
    print("üì¶ C√†i ƒë·∫∑t: pip install browser-cookie3")
    sys.exit(1)

from colorama import init, Fore, Style

# Kh·ªüi t·∫°o colorama
init(autoreset=True)


def export_cookies_from_browser(browser_name, output_file='youtube_cookies.txt'):
    """
    Export cookies t·ª´ tr√¨nh duy·ªát
    
    Args:
        browser_name (str): T√™n tr√¨nh duy·ªát ('chrome', 'edge', 'firefox')
        output_file (str): T√™n file output
    """
    print(f"{Fore.CYAN}üç™ ƒêang export cookies t·ª´ {browser_name.title()}...")
    
    try:
        # L·∫•y cookies t·ª´ tr√¨nh duy·ªát
        if browser_name == 'chrome':
            cookies = browser_cookie3.chrome(domain_name='youtube.com')
        elif browser_name == 'edge':
            cookies = browser_cookie3.edge(domain_name='youtube.com')
        elif browser_name == 'firefox':
            cookies = browser_cookie3.firefox(domain_name='youtube.com')
        else:
            print(f"{Fore.RED}‚ùå Tr√¨nh duy·ªát kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£: {browser_name}")
            return False
        
        # Chuy·ªÉn sang list ƒë·ªÉ ƒë·∫øm
        cookie_list = list(cookies)
        
        if not cookie_list:
            print(f"{Fore.YELLOW}‚ö†Ô∏è  Kh√¥ng t√¨m th·∫•y cookies YouTube trong {browser_name.title()}")
            print(f"{Fore.CYAN}   üí° ƒê·∫£m b·∫£o b·∫°n ƒë√£ ƒëƒÉng nh·∫≠p YouTube tr√™n {browser_name.title()}")
            return False
        
        # L∆∞u cookies v√†o file (ƒë·ªãnh d·∫°ng Netscape)
        output_path = Path(output_file)
        
        with open(output_path, 'w', encoding='utf-8') as f:
            # Header Netscape
            f.write("# Netscape HTTP Cookie File\n")
            f.write("# This file is generated by export_cookies.py\n")
            f.write("# Do not edit.\n\n")
            
            # Ghi t·ª´ng cookie
            for cookie in cookie_list:
                # Format: domain flag path secure expiration name value
                domain = cookie.domain
                flag = 'TRUE' if domain.startswith('.') else 'FALSE'
                path = cookie.path
                secure = 'TRUE' if cookie.secure else 'FALSE'
                expiration = str(cookie.expires) if cookie.expires else '0'
                name = cookie.name
                value = cookie.value
                
                line = f"{domain}\t{flag}\t{path}\t{secure}\t{expiration}\t{name}\t{value}\n"
                f.write(line)
        
        print(f"{Fore.GREEN}‚úÖ Th√†nh c√¥ng!")
        print(f"{Fore.GREEN}   ‚Ä¢ Export ƒë∆∞·ª£c {Style.BRIGHT}{len(cookie_list)} {Fore.GREEN}cookies")
        print(f"{Fore.GREEN}   ‚Ä¢ L∆∞u t·∫°i: {Style.BRIGHT}{output_path.absolute()}")
        print(f"{Fore.CYAN}   ‚Ä¢ Dung l∆∞·ª£ng: {output_path.stat().st_size} bytes")
        
        return True
        
    except Exception as e:
        print(f"{Fore.RED}‚ùå L·ªói: {str(e)}")
        
        # G·ª£i √Ω gi·∫£i ph√°p
        error_msg = str(e).lower()
        if 'permission' in error_msg or 'access' in error_msg:
            print(f"\n{Fore.YELLOW}üí° Gi·∫£i ph√°p:")
            print(f"{Fore.CYAN}   1. ƒê√≥ng {browser_name.title()} ho√†n to√†n")
            print(f"{Fore.CYAN}   2. Ch·∫°y l·∫°i script n√†y")
        elif 'decrypt' in error_msg:
            print(f"\n{Fore.YELLOW}üí° Gi·∫£i ph√°p:")
            print(f"{Fore.CYAN}   1. C√†i: pip install pycryptodomex")
            print(f"{Fore.CYAN}   2. Ho·∫∑c th·ª≠ tr√¨nh duy·ªát kh√°c (Firefox)")
        
        return False


def main():
    """H√†m ch√≠nh"""
    print(f"{Fore.MAGENTA}{Style.BRIGHT}")
    print("=" * 60)
    print("üç™ Export YouTube Cookies t·ª´ Tr√¨nh duy·ªát")
    print("=" * 60)
    print(f"{Style.RESET_ALL}\n")
    
    # Danh s√°ch tr√¨nh duy·ªát
    browsers = [
        ('edge', 'Microsoft Edge'),
        ('chrome', 'Google Chrome'),
        ('firefox', 'Mozilla Firefox'),
    ]
    
    print(f"{Fore.CYAN}üìã Ch·ªçn tr√¨nh duy·ªát:\n")
    for i, (name, display) in enumerate(browsers, 1):
        print(f"{Fore.WHITE}   {i}. {display}")
    
    print()
    choice = input(f"{Fore.YELLOW}Ch·ªçn s·ªë (1-3): {Style.BRIGHT}").strip()
    
    try:
        index = int(choice) - 1
        if 0 <= index < len(browsers):
            browser_name, display_name = browsers[index]
        else:
            print(f"{Fore.RED}‚ùå L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá!")
            sys.exit(1)
    except ValueError:
        print(f"{Fore.RED}‚ùå Vui l√≤ng nh·∫≠p s·ªë!")
        sys.exit(1)
    
    print(f"\n{Fore.CYAN}üîç ƒê√£ ch·ªçn: {Style.BRIGHT}{display_name}")
    print()
    
    # Ki·ªÉm tra ƒë√£ ƒë√≥ng tr√¨nh duy·ªát ch∆∞a
    print(f"{Fore.YELLOW}‚ö†Ô∏è  QUAN TR·ªåNG:")
    print(f"{Fore.CYAN}   ƒê·∫£m b·∫£o b·∫°n ƒë√£:")
    print(f"{Fore.CYAN}   1. ƒêƒÉng nh·∫≠p YouTube tr√™n {display_name}")
    print(f"{Fore.CYAN}   2. ƒê√ìNG {display_name} ho√†n to√†n")
    print()
    
    confirm = input(f"{Fore.YELLOW}ƒê√£ s·∫µn s√†ng? (Y/n): {Style.BRIGHT}").strip().lower()
    if confirm not in ['', 'y', 'yes', 'c√≥']:
        print(f"{Fore.RED}‚ùå ƒê√£ h·ªßy!")
        sys.exit(0)
    
    print()
    
    # Export cookies
    success = export_cookies_from_browser(browser_name)
    
    if success:
        print(f"\n{Fore.GREEN}{'='*60}")
        print(f"{Fore.GREEN}‚úÖ HO√ÄN T·∫§T!")
        print(f"{Fore.GREEN}{'='*60}")
        print(f"\n{Fore.CYAN}üìù B∆∞·ªõc ti·∫øp theo:")
        print(f"{Fore.CYAN}   1. File {Style.BRIGHT}youtube_cookies.txt {Fore.CYAN}ƒë√£ s·∫µn s√†ng")
        print(f"{Fore.CYAN}   2. Ch·∫°y: {Style.BRIGHT}python download_youtube_mp3.py")
        print(f"{Fore.CYAN}   3. Tool s·∫Ω t·ª± ƒë·ªông d√πng cookies t·ª´ file!")
        print()
        print(f"{Fore.GREEN}üí° Cookies c√≥ th·ªÉ d√πng trong 30-90 ng√†y")
        print(f"{Fore.GREEN}   Khi h·∫øt h·∫°n, ch·ªâ c·∫ßn ch·∫°y l·∫°i script n√†y!")
    else:
        print(f"\n{Fore.RED}{'='*60}")
        print(f"{Fore.RED}‚ùå TH·∫§T B·∫†I!")
        print(f"{Fore.RED}{'='*60}")
        print(f"\n{Fore.CYAN}üìñ Xem h∆∞·ªõng d·∫´n chi ti·∫øt:")
        print(f"{Fore.CYAN}   File: {Style.BRIGHT}EXPORT_COOKIES.md")
        print()
        print(f"{Fore.YELLOW}üí° Gi·∫£i ph√°p thay th·∫ø:")
        print(f"{Fore.CYAN}   D√πng Extension 'Get cookies.txt LOCALLY' (d·ªÖ h∆°n)")
        print(f"{Fore.CYAN}   Xem h∆∞·ªõng d·∫´n trong EXPORT_COOKIES.md")


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print(f"\n{Fore.YELLOW}ƒê√£ h·ªßy!")
        sys.exit(0)
    except EOFError:
        print(f"\n{Fore.RED}ƒê√£ h·ªßy!")
        sys.exit(0)



